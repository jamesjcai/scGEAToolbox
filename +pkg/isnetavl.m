function [connected, timing] = isnetavl(use_HTML_test_only)
%Check for an internet connection by pinging Google
%
% Syntax:
%   [connected,timing]=isnetavl(use_HTML_test_only)
%
% Input/output arguments:
% connected:
%   A logical denoting the connectivity. Note that this may return unexpected results if Matlab has
%   separate proxy settings and/or if your DNS is having issues.
% timing:
%   This contains the ping time as a double and defaults to 0 if there is no connection.
%   Note that this value will be larger than the true ping time if the HTML fallback is used.
% use_HTML_test_only:
%   If the input is convertible to true the HTML method will be used, which has the benefit of
%   testing if Matlab (or Octave) is able to connect to the internet. This might be relevant if
%   there are proxy settings or firewall rules specific to Matlab/Octave.
%   Note that the ping value will be larger than the true value if the HTML fallback is used.
%
%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%
%|                                                                         |%
%|  Version: 2.0.1                                                         |%
%|  Date:    2022-04-20                                                    |%
%|  Author:  H.J. Wisselink                                                |%
%|  Licence: CC by-nc-sa 4.0 ( creativecommons.org/licenses/by-nc-sa/4.0 ) |%
%|  Email = 'h_j_wisselink*alumnus_utwente_nl';                            |%
%|  Real_email = regexprep(Email,{'*','_'},{'@','.'})                      |%
%|                                                                         |%
%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%
%
% Tested on several versions of Matlab (ML 6.5 and onward) and Octave (4.4.1 and onward), and on
% multiple operating systems (Windows/Ubuntu/MacOS). For the full test matrix, see the HTML doc.
% Compatibility considerations:
% - This is expected to work on all releases.
% - If you have proxy/firewall settings specific to Matlab/Octave, make sure to use the HTML method
%   by providing an input.

if nargin == 0, tf = false;
else, [tf1, tf2] = test_if_scalar_logical(use_HTML_test_only);
    tf = tf1 && tf2;
end
if tf
    %(the timing is not reliable)
    [connected, timing] = isnetavl___ping_via_html;
    return
end

tf = isnetavl__ICMP_is_blocked;
if isempty(tf)
    %Unable to determine if ping is allowed, the connection must be down.
    connected = 0;
    timing = 0;
else
    if tf
        %Ping is not allowed.
        %(the timing is not reliable)
        [connected, timing] = isnetavl___ping_via_html;
    else
        %Ping is allowed.
        [connected, timing] = isnetavl___ping_via_system;
    end
end
end
function tf = ifversion(test, Rxxxxab, Oct_flag, Oct_test, Oct_ver)
%Determine if the current version satisfies a version restriction
%
% To keep the function fast, no input checking is done. This function returns a NaN if a release
% name is used that is not in the dictionary.
%
% Syntax:
%   tf=ifversion(test,Rxxxxab)
%   tf=ifversion(test,Rxxxxab,'Octave',test_for_Octave,v_Octave)
%
% Input/output arguments:
% tf:
%   If the current version satisfies the test this returns true. This works similar to verLessThan.
% Rxxxxab:
%   A char array containing a release description (e.g. 'R13', 'R14SP2' or 'R2019a') or the numeric
%   version (e.g. 6.5, 7, or 9.6).
% test:
%   A char array containing a logical test. The interpretation of this is equivalent to
%   eval([current test Rxxxxab]). For examples, see below.
%
% Examples:
% ifversion('>=','R2009a') returns true when run on R2009a or later
% ifversion('<','R2016a') returns true when run on R2015b or older
% ifversion('==','R2018a') returns true only when run on R2018a
% ifversion('==',9.9) returns true only when run on R2020b
% ifversion('<',0,'Octave','>',0) returns true only on Octave
% ifversion('<',0,'Octave','>=',6) returns true only on Octave 6 and higher
%
% The conversion is based on a manual list and therefore needs to be updated manually, so it might
% not be complete. Although it should be possible to load the list from Wikipedia, this is not
% implemented.
%
%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%
%|                                                                         |%
%|  Version: 1.1.1                                                         |%
%|  Date:    2022-03-14                                                    |%
%|  Author:  H.J. Wisselink                                                |%
%|  Licence: CC by-nc-sa 4.0 ( creativecommons.org/licenses/by-nc-sa/4.0 ) |%
%|  Email = 'h_j_wisselink*alumnus_utwente_nl';                            |%
%|  Real_email = regexprep(Email,{'*','_'},{'@','.'})                      |%
%|                                                                         |%
%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%/%
%
% Tested on several versions of Matlab (ML 6.5 and onward) and Octave (4.4.1 and onward), and on
% multiple operating systems (Windows/Ubuntu/MacOS). For the full test matrix, see the HTML doc.
% Compatibility considerations:
% - This is expected to work on all releases.

% The decimal of the version numbers are padded with a 0 to make sure v7.10 is larger than v7.9.
% This does mean that any numeric version input needs to be adapted. multiply by 100 and round to
% remove the potential for float rounding errors.
% Store in persistent for fast recall (don't use getpref, as that is slower than generating the
% variables and makes updating this function harder).
persistent v_num v_dict octave
if isempty(v_num)
    % Test if Octave is used instead of Matlab.
    octave = exist('OCTAVE_VERSION', 'builtin');

    % Get current version number. This code was suggested by Jan on this thread:
    % https://mathworks.com/matlabcentral/answers/1671199#comment_2040389
    v_num = [100, 1] * sscanf(version, '%d.%d', 2);

    % Get dictionary to use for ismember.
    v_dict = { ...
        'R13', 605; 'R13SP1', 605; 'R13SP2', 605; 'R14', 700; 'R14SP1', 700; 'R14SP2', 700; ...
        'R14SP3', 701; 'R2006a', 702; 'R2006b', 703; 'R2007a', 704; 'R2007b', 705; ...
        'R2008a', 706; 'R2008b', 707; 'R2009a', 708; 'R2009b', 709; 'R2010a', 710; ...
        'R2010b', 711; 'R2011a', 712; 'R2011b', 713; 'R2012a', 714; 'R2012b', 800; ...
        'R2013a', 801; 'R2013b', 802; 'R2014a', 803; 'R2014b', 804; 'R2015a', 805; ...
        'R2015b', 806; 'R2016a', 900; 'R2016b', 901; 'R2017a', 902; 'R2017b', 903; ...
        'R2018a', 904; 'R2018b', 905; 'R2019a', 906; 'R2019b', 907; 'R2020a', 908; ...
        'R2020b', 909; 'R2021a', 910; 'R2021b', 911; 'R2022a', 912};
end

if octave
    if nargin == 2
        warning('HJW:ifversion:NoOctaveTest', ...
            ['No version test for Octave was provided.', char(10), ...
                'This function might return an unexpected outcome.']) %#ok<CHARTEN>
                if isnumeric(Rxxxxab)
                    v = 0.1 * Rxxxxab + 0.9 * fix(Rxxxxab);
                    v = round(100*v);
                else
                    L = ismember(v_dict(:, 1), Rxxxxab);
                    if sum(L) ~= 1
                        warning('HJW:ifversion:NotInDict', ...
                            'The requested version is not in the hard-coded list.')
                        tf = NaN; return
                    else
                        v = v_dict{L, 2};
                    end

                end

            elseif nargin == 4
                % Undocumented shorthand syntax: skip the 'Octave' argument.
                [test, v] = deal(Oct_flag, Oct_test);
                % Convert 4.1 to 401.
                v = 0.1 * v + 0.9 * fix(v);
                v = round(100*v);
            else
                [test, v] = deal(Oct_test, Oct_ver);
                % Convert 4.1 to 401.
                v = 0.1 * v + 0.9 * fix(v);
                v = round(100*v);
    end

        else
            % Convert R notation to numeric and convert 9.1 to 901.
            if isnumeric(Rxxxxab)
                v = 0.1 * Rxxxxab + 0.9 * fix(Rxxxxab);
                v = round(100*v);
            else
                L = ismember(v_dict(:, 1), Rxxxxab);
                if sum(L) ~= 1
                    warning('HJW:ifversion:NotInDict', ...
                        'The requested version is not in the hard-coded list.')
                    tf = NaN; return
                else
                    v = v_dict{L, 2};
                end
            end

end

        switch test
            case '==', tf = v_num == v;
            case '<', tf = v_num < v;
            case '<=', tf = v_num <= v;
            case '>', tf = v_num > v;
            case '>=', tf = v_num >= v;
        end
    end
    function [connected, timing] = isnetavl___ping_via_html
        %Ping is blocked by some organizations. As an alternative, the google.com page can be loaded as a
        %normal HTML, which should work as well, although it is slower. This also means the ping timing is
        %no longer reliable.
        persistent UseWebread
        if isempty(UseWebread)
            try no_webread = isempty(which(func2str(@webread)));
            catch, no_webread = true;
            end
            UseWebread = ~no_webread;
        end
        try
            then = datetime("now");
            if UseWebread
                str = webread('http://google.com'); %#ok<NASGU>
            else
                str = urlread('http://google.com'); %#ok<NASGU,URLRD>
            end
            connected = 1;
            timing = (datetime('now') - then) * 24 * 3600 * 1000;
        catch
            connected = 0;
            timing = 0;
        end
    end
    function [connected, timing] = isnetavl___ping_via_system
        if ispc
            try
                %                                   8.8.4.4 will also work
                [ignore_output, b] = system('ping -n 1 8.8.8.8'); %#ok<ASGLU> ~
                stats = b(strfind(b, ' = ')+3);
                stats = stats(1:3); %[sent received lost]
                if ~strcmp(stats, '110')
                    error('trigger error')
                else
                    %This branch will error for 'destination host unreachable'.
                    connected = 1;
                    %This assumes there is only one place with '=[digits]ms' in the response, but this code
                    %is not language-specific.
                    [ind1, ind2] = regexp(b, ' [0-9]+ms');
                    timing = b((ind1(1) + 1):(ind2(1) - 2));
                    timing = str2double(timing);
                end
            catch
                connected = 0;
                timing = 0;
            end
        elseif isunix
            try
                %                                   8.8.4.4 will also work
                [ignore_output, b] = system('ping -c 1 8.8.8.8'); %#ok<ASGLU> ~
                ind = regexp(b, ', [01] ');
                if b(ind+2) ~= '1'
                    %This branch includes 'destination host unreachable' errors.
                    error('trigger error')
                else
                    connected = 1;
                    %This assumes the first place with '=[digits] ms' in the response contains the ping
                    %timing. This code is not language-specific.
                    [ind1, ind2] = regexp(b, '=[0-9.]+ ms');
                    timing = b((ind1(1) + 1):(ind2(1) - 2));
                    timing = str2double(timing);
                end
            catch
                connected = 0;
                timing = 0;
            end
        else
            error('How did you even get Matlab to work?')
        end
    end
    function [tf, connected, timing] = isnetavl__ICMP_is_blocked
        %Check if ICMP 0/8/11 is blocked.
        %
        %tf is empty if both methods fail.

        persistent output
        if ~isempty(output)
            tf = output; return
        end

        %First check if ping works.
        [connected, timing] = isnetavl___ping_via_system;
        if connected
            %Ping worked and there is an internet connection.
            output = false;
            tf = false;
            return
        end

        %There are two options: no internet connection, or ping is blocked.
        [connected, timing] = isnetavl___ping_via_html;
        if connected
            %There is an internet connection, therefore ping must be blocked.
            output = true;
            tf = true;
            return
        end

        %Both methods failed, internet is down. Leave the value of tf (and the persistent variable) set to
        %empty so it is tried next time.
        tf = [];
    end
    function [isLogical, val] = test_if_scalar_logical(val)
        %Test if the input is a scalar logical or convertible to it.
        %The char and string test are not case sensitive.
        %(use the first output to trigger an input error, use the second as the parsed input)
        %
        % Allowed values:
        %- true or false
        %- 1 or 0
        %- 'on' or 'off'
        %- "on" or "off"
        %- matlab.lang.OnOffSwitchState.on or matlab.lang.OnOffSwitchState.off
        %- 'enable' or 'disable'
        %- 'enabled' or 'disabled'
        persistent states
        if isempty(states)
            states = {true, false; ...
                1, 0; ...
                'on', 'off'; ...
                'enable', 'disable'; ...
                'enabled', 'disabled'};
            if ifversion('>=', 'R2016b', '<', 0)
                states(end+1, :) = {string('on'), string('off')}; %#ok<STRQUOT>
            end
        end
        isLogical = true;
        try
            if isa(val, 'char') || isa(val, 'string')
                try val = lower(val); catch, end
            end
            for n = 1:size(states, 1)
                for m = 1:2
                    if isequal(val, states{n, m})
                        val = states{1, m}; return
                    end
                end
            end
            if isa(val, 'matlab.lang.OnOffSwitchState')
                val = logical(val); return
            end
        catch
        end
        isLogical = false;
    end